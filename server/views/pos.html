<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>pos</title>
<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
<script src="js/lodash.min.js" type="text/javascript"></script>
<style media="screen">
      *{
      margin: 0;
      padding: 0
      }
      li{
        list-style: none;
      }
      a{
        text-decoration: none;
        color: #fff;
      }
      .warp{
        width: 1024px;
        height: 768px;
        margin: 0 auto;

        position: relative;
      }
      .top{
        width: 100%;
        height: 73px;
        background: url(images/header-2.jpg) no-repeat 0 0;
        background-size: cover;
        overflow: hidden;
      }
      .top-left{
        width: 45px;
        height: 45px;
        background: url(images/orange.png) no-repeat 0 0;
        background-size: contain;
        line-height: 45px;
        text-align: center;
        margin-top: 12px;
        margin-left: 19px;
        float: left;
      }
      .top-center{
        width: 216px;
        height: 73px;
        background: url(images/shopname.png) no-repeat 0 0;
        background-size: contain;
        position: absolute;
        top: 9px;
        left: 43%;
        color: #fff;
        text-align: center;

      }
      .top-center span{
        display: inline-block;
        padding-top: 16px;
        font-weight: 600;
        opacity: 0.8;
      }
      .top-right{
        float: right;
        margin-right: 19px;
        margin-top: 12px;
      }
      .top-right-left{
        width: 25px;
        height: 25px;
        background: url(images/header-1.png) no-repeat 0 0;
        background-size: contain;
      }

      /*中间部分*/
      .middle{
        width: 100%;
        height: 560px;
        background: url(images/header-2.jpg) no-repeat 0 0;
        background-size: cover;
        overflow: hidden;
      }
      .middle-tiaoma{
        width: 265px;
        float: right;
        position: absolute;
        top:82px;
        right: -30px;
        overflow: hidden;
      }
      .tiaoma-left{
        width:20px;
        height:15px;
        background: url(images/tiaoma.png) no-repeat 0 0;
        background-size: cover;
        display: inline-block;

      }
      .tiaoma-right{
        margin-top: -2px;
        width: 162px;
        height: 22px;
        display: inline-block;
        outline: none;
        -webkit-appearance : none ;
        vertical-align: middle;
        border: none;
      }
      .middle-product{
        width: 944px;
        height: 470px;
        background: #fff;
        margin: 0 auto;
        margin-top: 23px;

      }
      .product-infor{
        width: 210px;
        height: 210px;
        margin-top:10px;
        margin: 10px 6px 0;
        display: inline-block;

      }

      .product-infor p{
        width: 170px;
        margin: 0 auto;
        font-size: 14px;
        padding-bottom: 5px;
        color: #6d40ae;
      }
      .product-img{
        width: 176px;
        height: 170px;
        margin: 0 auto;
		text-align: center;
      }
      .product-img img{
        width: 170px;
        height: 170px;
      }
      .product-infor span:first-child{
        font-size: 18px;
        color: red;
        margin-left: 21px;
      }
      .product-infor span:last-child{
        font-size:18px;
        color: #FF0000;
        float: right;
        margin-right: 23px;
      }
      .product-conver{
        /*display: none;*/
        width: 930px;
        margin: 0 auto;
        overflow: auto;
        height: 470px;
      }
     /*底                部*/
     .footer{
       background: url(images/footer.jpg) no-repeat 0 0;
       background-size: cover;
       overflow: hidden;
     }
     .footer-left{
       width: 140px;
       height: 130px;
       float: left;

     }
     .footer-left p{
       font-size: 12px;
       font-weight: 400;
       text-align: center;
       line-height: 15px;
       color: #fff;
    }
    .footer-left p:first-child{
      margin-top: 47px;
    }
    .footer-center{
      width: 714px;
      height: 130px;
      float: left;
    }
    .footer-center-nav{
      display: flex;
      margin-top: 43px;
    }
    .footer-center-nav li{
      flex: 1;
    }
    .nav-infor{
      width: 79px;
      height:64px;
      margin: 0 auto;
    }
    .footer-center-nav li p{
      color: #5B5B5B;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
    }
    .nav-infor img{
      width: 69px;
      height:59px;
    }
    .footer-right{
      float: right;
      margin-right:10px;
      width: 160px;
      height: 130px;
      background: url(images/jiesuan.png) no-repeat 0 0;
      background-size: cover;
    }
    .footer-right p{
      text-align: center;
      color: #fff;
    }
    .footer-right p:first-child{
      margin-top: 57px;
      font-size: 18px;
      font-weight: 600;
    }
    .footer-right p:last-child{
        margin-top: 17px;
        font-size: 14px;
        text-align: center;

    }
    .ma-num{
      display: inline-block;
      padding-top: 20px;
      margin-left: 40px;
      color: #fff;
    }
	.weui_mask {
		position: fixed;
		z-index: 10;
		width: 100%;
		height: 100%;
		top: 0;
		left: 0;
		background: rgba(0, 0, 0, 0.6);
	}
	.weui_dialog {
		position: fixed;
		z-index: 13;
		width: 380px;
    	height: 180px;
		top: 50%;
		left: 53%;
		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
		background-color: #FAFAFC;
		border-radius: 3px;
		overflow: hidden;
	}
	.curr{
		border:1px solid #000;
	}
	.get_member{
		height: 75px;
	    margin: 30px;
	    font-size: 24px;
	}
	.member_phone{
		margin-left: 12px;
		width: 165px;
		padding: 2px;
		height: 24px;
		font-size: 16px;
	}
	.member_button{
		width: 94px;
	    font-size: 16px;
	    height: 30px;
	    float: left;
	    line-height: 30px;
	    border: 1px solid #CECECE;
	    margin-left: 62px;
	    cursor: pointer;
	    text-align: center;
	}
	.weui_mask2 {
		position: fixed;
		z-index: 10;
		width: 100%;
		height: 100%;
		top: 0;
		left: 0;
		background: rgba(0, 0, 0, 0.6);
	}
	.weui_dialog2 {
		position: fixed;
		z-index: 13;
		width: 896px;
		top: 50%;
		left: 53%;
		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
		background-color: #FAFAFC;
		border-radius: 3px;
		overflow: hidden;
	}
	#guadan_info{
		height:600px;
		width:100%;
	}
	.hover{
		border:1px solid red;
	}
	.pay_table{
		height:200px;
		width: 800px;
		margin: 20px auto;
	}
	table.pay_way_infos {
		font-family: verdana,arial,sans-serif;
		font-size:11px;
		color:#333333;
		border-width: 1px;
		border-color: #666;
		border-collapse: collapse;
		width: 100%;
	}
	table.pay_way_infos th {
		border-width: 1px;
		padding: 8px;
		border-style: solid;
		border-color: #666666;
		background-color: #dedede;
		font-size: 18px;
	}
	table.pay_way_infos td {
		border-width: 1px;
		padding: 8px;
		border-style: solid;
		border-color: #666666;
		background: #F7F7F7;
		font-size: 14px;
	}
	.table_flow{
		overflow: auto;
	}
</style>
</head>
  <body>
	<div class="member_info" style="display:none;">
	  <div class="weui_mask"></div>
	  <div class="weui_dialog">
		  <div class="get_member">
			  <span>会员卡号：</span> <input class="member_phone" type="text" value="" placeholder="请输入会员卡号/手机号" autofocus/>
		  </div>
		  <div>
			  <div class="member_button" id="member_enter">确定</div>
			  <div class="member_button" id="member_cancel">取消</div>
		  </div>
	  </div>
	</div>
	<div class="content" style="display:none;">
	  <div class="weui_mask"></div>
	  <div class="weui_dialog">
		  <input id="update_id" value="" style="display:none;"/>
		  <div id="update_name"></div>
		  <input id="update_price" value=""/>
		  <input id="update_number" value=""/>
		  <div class="save">保存</div>
		  <div class="close">关闭</div>
	  </div>
	</div>
	<div id="pay_info" style="display:none;">
		<div class="weui_mask2"></div>
		<div class="weui_dialog2">
			<div style="height:600px;width:100%;">
				<div style="width:800px;margin:20px auto;height:300px;">
					<div class="cash" style="border:1px solid #dedede;float:left;height:200px;width:100px;background-color:green">
						<div style="font-size:24px;">现金</div>
					</div>
					<div class="alipay" style="border:1px solid #dedede;float:left;height:200px;width:100px;background-color:yellow">
						<div style="font-size:24px;">支付宝</div>
					</div>
					<div class="member_card" style="border:1px solid #dedede;float:left;height:200px;width:100px;background-color:red">
						<div style="font-size:24px;">会员卡</div>
					</div>
					<div style="clear:both;"></div>
					<div class="pay_amount"></div>
					<div class="cash_pay" style="display:none;">
						现金：<input class="cash_value" type="text" value=""/>
					</div>
					<div class="alipay_pay" style="display:none;">
						支付宝：<input class="alipay_value" type="text" value="" data-id="1"/>
					</div>
					<div class="member_pay" style="display:none;">
						卡号：<input class="member_number" type="text" value="" placeholder="会员还未登记！" readonly/>
						金额：<input class="member_value" type="text" value=""/>
						支付码：<input class="member_pay_card" type="text" value=""/>
					</div>
					<div class="pay_more" style="display:none;">
						<div>已超额支付，请找零！</div>
					</div>
					<div class="change" style="display:none;">
						找零：<input class="change_value" type="text" value="" readonly=""/>
					</div>
					<div class="print_invoice" style="display:none;">打印发票</div>
					<div class="leave" >清除</div>
					<div class="back" >返回</div>
					<div style="clear:both;"></div>
				</div>
				<div class="pay_table">
				</div>
			</div>
		</div>
	</div>
	<script id="pay_table_infos" type="text/template">
		<table class="pay_way_infos">
			<tr>
				<th>序号</th><th>支付方式</th><th>支付金额</th><th>流水号</th>
			</tr>
			<div class="table_flow">
				<% _.forEach(pay_infos, function(pay_info,index) { %>
					<tr>
						<td><%- index+1 %></td>
						<td><%- pay_info.pay_way %></td>
						<td><%- pay_info.pay_amount %></td>
						<td><%- pay_info.fin %></td>
					</tr>
				<% }); %>
			</div>
			<tr>
				<th>总付金额</th><th>已付金额</th><th>待付金额</th><th></th>
			</tr>
			<tr>
				<td><%- shopping_infos.total_price %></td>
				<td><%- shopping_infos.ready_pay %></td>
				<td><%- shopping_infos.pre_pay %></td>
				<td></td>
			</tr>
		</table>
	</script>
	<div class="do_clear" style="display:none;">
		<div class="weui_mask"></div>
		<div class="weui_dialog">
			<div style="height:100px;">
				<div class="yes" style="border:1px solid #000;width:47%;margin:1%;float:left;">是</div>
				<div class="no" style="border:1px solid #000;width:48%;margin:1%;float:left;">否</div>
			</div>
		</div>
	</div>
	<div class="warp">
      <div class="top">
        <div class="top-left"><a href="#">返回</a></div>
        <div class="top-center"><span><u>{{store_info[0].org_store_name}}</u></span></div>
        <div class="top-right">
          <div class="top-right-left"></div>
          <span><a href="#">{{person_info.person.person_code}}</a></span>
        </div>
      </div>
      <div class="middle">
        <div class="ma-num">
          机器编号：001
        </div>
        <div class="middle-tiaoma">
          <div class="tiaoma-left"></div>
          <input type="text" name="" value="" class="tiaoma-right" style="padding-left: 5px;" id="barcode">
        </div>

        <!-- 商品显示 -->
        <div class="middle-product">
          <ul class="product-conver" id="product_infos">
          </ul>
        </div>
      </div>
      <div class="footer">
        <div class="footer-left">
          <p class="member_name"></p>
          <p class="member_integral"></p>
          <p class="member_amount"></p>
        </div>
        <div class="footer-center">
          <ul class="footer-center-nav">
            <li>
              <div class="nav-infor member">
                <div class="nav-img">
                  <img src="images/yu.png" alt="">
                </div>

              </div>
              <p>会员卡</p>
            </li>
            <li>
              <div class="nav-infor" id="put_order">
                <div class="nav-img">
                  <img src="images/yuan.png" alt="">
                </div>
              </div>
              <p>挂单</p>
            </li>
            <li>
              <div class="nav-infor" id="get_order">
                <div class="nav-img">
                  <img src="images/fu.png" alt="">
                </div>
              </div>
              <p>取单</p>
            </li>
            <li>
              <div class="nav-infor" id="clear">
                <div class="nav-img">
                  <img src="images/jianzhi-fu.png" alt="">
                </div>
              </div>
              <p>作废</p>
            </li>
            <li>
              <div class="nav-infor">
                <div class="nav-img">
                  <img src="images/deng.png" alt="">
                </div>
              </div>
              <p>弹出钱箱</p>
            </li>

          </ul>
        </div>
        <div class="footer-right" id="pay">
          <p><u id="amount">￥0</u></p>
          <p>结算</p>
        </div>
      </div>
    </div>
	<div id="guadan" style="display:none;">
		<div class="weui_mask2"></div>
		<div class="weui_dialog2">
			<div id="guadan_info">
			</div>
		</div>
	</div>
	<audio class="success"><source src="js/notify.ogg" type="audio/ogg"><source src="js/notify.mp3" type="audio/mpeg"><source src="js/notify.wav" type="audio/wav"></audio>
	<audio class="fail"><source src="js/7499.wav" type="audio/wav"></audio>
	<script id="qudan" type="text/template">
		<div>挂单信息</div>
		<% _.forEach(temp_products, function(order,index) { %>
		<div class="qudan_line" data-id="<%- index %>">
			<%- index+1 %>
			<div>时间：<%- order.products.guadan_time %></div>
			<% _.forEach(order.products, function(product) { %>
				<div>商品名称：<%- product.product_name %>
					价格：<%- product.product_price %>
					数量：<%- product.product_number %>
				</div>
			<% }); %>
		</div>
		<% }); %>
	</script>
	<script id="products" type="text/template">
		<% _.forEach(products, function(product,index) { %>
			<li class="product-infor product_line" data-id="<%- index+1 %>" id="<%- product.barcode %>">
              <div class="product-img">	<% if (product.delay) { %><img src="/images/<%- product.picture %>" alt="" class="<%- product.barcode %>"><% }else{ %><img src="images/delay.gif" alt="" class="<%- product.barcode %>" data-src="/images/<%- product.picture %>" style="width:62px;height:62px;padding-top:50px;"> <% } %></div>
              <p><%- product.product_name %>
				  <% _.forEach(product.sale_properties, function(sale_property) { %>
					  <% if (product.stock_options[sale_property.field_name]) { %>
					  	<%- sale_property.name %>:<%- product.stock_options[sale_property.field_name] %>
					  <% } %>
			      <% }); %>
			  </p>
              <div class="price">
                <span>￥<%- product.product_price %></span><span>X<%- product.product_number %></span>
              </div>
            </li>

		<% }); %>
	</script>
	<script>
		$(function() {
			var store_address = "{{store_info[0].address}}";
			var person_id = "{{person_info.person_id}}";
			var order = {
				"shopping_infos" : {
					"total_price":parseFloat(0),
					"total_discount":parseFloat(0),
					"marketing_price":parseFloat(0),
					"ready_pay":parseFloat(0),
					"pre_pay":parseFloat(0)
				},
				"member" : null,
				"products" : [],
				"pay_way" : [],
				"order_id" : null,
				"fin" : null,
				"pay_infos" : []
			};
			//挂单用的临时变量
			var temp_products = [];
			//支付方式选择
			var pay_way_status = 0; //现金 0，支付宝 1，会员卡 2, 付款超额 10
			var pay_way_change = function(pay_way_status){
				$(".pay_amount").html("应付："+order.shopping_infos.total_price);
				if (pay_way_status == 0) {
					$(".cash_pay").removeAttr("style");
					order.shopping_infos.total_price = parseFloat(parseInt(order.shopping_infos.total_price*10)/10);
					$(".pay_amount").html("应付："+order.shopping_infos.total_price);
					$(".alipay_pay").attr("style","display:none;");
					$(".member_pay").attr("style","display:none;");
					$(".pay_more").attr("style","display:none;");
				}else if (pay_way_status == 1) {
					$(".alipay_pay").removeAttr("style");
					$(".member_pay").attr("style","display:none;");
					$(".cash_pay").attr("style","display:none;");
					$(".pay_more").attr("style","display:none;");
				}else if (pay_way_status == 2) {
					$(".member_pay").removeAttr("style");
					$(".alipay_pay").attr("style","display:none;");
					$(".cash_pay").attr("style","display:none;");
					$(".pay_more").attr("style","display:none;");
				}else if (pay_way_status == 10) {
					$(".pay_more").removeAttr("style");
					$(".member_pay").attr("style","display:none;");
					$(".alipay_pay").attr("style","display:none;");
					$(".cash_pay").attr("style","display:none;");
				}
			};
			pay_way_change(pay_way_status);
			//清除支付信息
			var init_pay_infos = function(){
				pay_way_status = 0;
				pay_way_change(pay_way_status);
				order = {
					"shopping_infos" : {
						"total_price":parseFloat(0),
						"total_discount":parseFloat(0),
						"marketing_price":parseFloat(0),
						"ready_pay":parseFloat(0),
						"pre_pay":parseFloat(0)
					},
					"member" : null,
					"products" : [],
					"pay_way" : [],
					"order_id" : null,
					"fin" : null,
					"pay_infos" : []
				};
				payment_info_table();
				product_infos();
				member_update();
				$(".member_value").removeAttr("readonly");
				$(".member_pay_card").removeAttr("readonly");
				// $(".pay_more").attr("style","display:none;");
				$(".cash_value").val("");
				$(".member_number").val("");
				$(".member_value").val("");
				$(".member_pay_card").val("");
				$(".change_value").val("");
				$(".alipay_value").val("");
			};
			//初始产品信息
			var init_product_infos = function(){
				order = {
					"shopping_infos" : {
						"total_price":0,
						"total_discount":0,
						"marketing_price":0
					},
					"member" : null,
					"products" : [],
					"pay_way" : [],
					"order_id" : null,
					"fin" : null
				};
				product_infos();
				$("#barcode").val("");
			};
			//添加现金支付记录
			var add_pay_info = function(pay_way,pay_amount,data){
				var pay_infos = {};
				pay_infos.pay_amount = pay_amount;
				pay_infos.pay_way = pay_way;
				pay_infos.fin = data.row.fin_occurrence_log_id;
				order.pay_infos.push(pay_infos);
				var ready_pay = parseFloat(0);
				var pre_pay = parseFloat(0);
				for (var i = 0; i < order.pay_infos.length; i++) {
					ready_pay = ready_pay + order.pay_infos[i].pay_amount;

				}
				ready_pay = parseFloat(parseInt(ready_pay*100)/100);
				console.log(ready_pay);
				pre_pay = order.shopping_infos.total_price - ready_pay;
				pre_pay = pre_pay.toFixed(2);
				console.log(pre_pay);
				order.shopping_infos.ready_pay = ready_pay;
				order.shopping_infos.pre_pay = pre_pay;
				if (order.shopping_infos.pre_pay < 0) {
					pay_way_status = 10;
					pay_way_change(pay_way_status);
				}
				payment_info_table();
			};
			//挂单
			$("#put_order").click(function(){
				if (order.products.length >0 && temp_products.length < 3) {
					order.guadan_time = new Date();
					temp_products.push(order);
					init_product_infos();
					member_update();
				}else if (order.products.length >0 && temp_products.length >= 3) {
					alert("挂单已满");
				}
				else {
					alert("无单可挂");
				}
			});
			//取单
			$("#get_order").click(function(){
				if (temp_products.length >0) {
					$("#guadan").removeAttr("style");
					guadan_info();
				}else {
					alert("无单可取");
				}
			});
			//挂单信息
			var guadan_info = function(){
				var t = _.template($("#qudan").html());
				$("#guadan_info").html(t({temp_products:temp_products}));
				$(".qudan_line").hover(
					function () {
						$(this).addClass("hover");
					},
					function () {
						$(this).removeClass("hover");
					}
				);
				$(".qudan_line").click(function(){
					var index = $(this).data("id");
					order = temp_products[index];
					product_infos();
					member_update();
					temp_products.splice(index,1);
					$("#barcode").val("");
					$("#guadan").attr("style","display:none;");
				});
			};
			//商品高亮
			var highlight = function(id){
				$("#"+id).removeClass("curr");
				$("#"+id).addClass("curr");
				$('div,ul').animate({scrollTop:$('#'+id).offset().top}, 800);
				// $("."+id).removeAttr("style");
			};
			//扫描条形码
			$("#barcode").keypress(function(e){
				var barcode = $("#barcode").val();
				var key = e.which;
				if (barcode && key == 13) {
					$("#barcode").val("");
					$.get("/get_product_info",{"barcode":barcode},function(data){
						if (data.success) {
							bobang_success();
							var product ={};
							product.product_id = data.row.id;
							product.product_code = data.row.code;
							product.product_name = data.row.product_name;
							product.product_price = data.row.product_sale_price;
							product.product_stock = data.stocks;
							product.product_color = data.row.color;
							product.product_number = 1;
							product.product_brand = data.row.product_brand;
							product.product_discount = 1;
							product.picture = data.picture_info.location;
							product.sale_properties = data.sale_properties;
							product.stock_options = data.stock_options;
							if (!product.picture) {
								product.picture = "images/delay.gif";
							}
							product.barcode = barcode;
							var add = true;
							for (var i = 0; i < order.products.length; i++) {
								if (order.products[i].barcode == product.barcode) {
									order.products[i].product_number = order.products[i].product_number +1;
									add = false;
									break;
								}
							}
							if (add) {
								order.products.push(product);
							}
							get_total_price();
							product_infos();
							get_picture();
							highlight(barcode);
						}else {
							bobang_fail();
						}
					});
				}
			});
			//获取图片
			var get_picture = function(){
				for (var i = 0; i < order.products.length; i++) {
					var product = order.products[i];
					if (!product.delay) {
						product.delay = 1;
						var oimg = new Image();
						oimg.onload = function() {
							var img = $("."+product.barcode);
							img.attr("src",img.data("src"));
							img.attr("style","");
						};
						oimg.src = $("."+product.barcode).data("src");

					}
				}
			};
			//播放成功
			var bobang_success = function(){
				$('.success')[0].pause();
				$('.success')[0].currentTime = 0;
				$('.success')[0].play();
			}
			//播放失败
			var bobang_fail = function(){
				$('.fail')[0].pause();
				$('.fail')[0].currentTime = 0;
				$('.fail')[0].play();
			}
			//计算总价
			var get_total_price = function(){
				order.shopping_infos.total_price = 0;
				for (var i = 0; i < order.products.length; i++) {
					if (order.member) {
						for (var j = 0; j < order.member.discounts.length; j++) {
							if (order.member.discounts[j].org_brand_id == order.products[i].product_brand) {
								order.products[i].product_discount = order.member.discounts[j].discount;
							}
						}
					}
					order.shopping_infos.marketing_price = order.shopping_infos.total_price + parseFloat(order.products[i].product_price) * order.products[i].product_number;
					order.shopping_infos.total_price = order.shopping_infos.total_price + parseFloat(order.products[i].product_price) * order.products[i].product_number * parseFloat(order.products[i].product_discount);
					order.shopping_infos.total_price6 = order.shopping_infos.total_price.toFixed(6);
					order.shopping_infos.total_price = parseFloat(parseInt(order.shopping_infos.total_price6*100)/100);
				}
			};
			//修改单条商品
			var show_one_line = function(index){
				var product_name = order.products[index].product_name;
				var product_price = order.products[index].product_price;
				var product_number = order.products[index].product_number;

				$(".content").removeAttr("style");

				$("#update_id").val(index);
				$("#update_name").html(product_name);
				$("#update_price").val(product_price);
				$("#update_number").val(product_number);

			};
			//保存单条商品信息
			var save_one_line = function(){
				var index = $("#update_id").val();
				var update_price = $("#update_price").val();
				var update_number =  $("#update_number").val();

				order.products[index].product_price = update_price;
				order.products[index].product_number = parseInt(update_number);

				$(".content").attr("style","display:none;");
				get_total_price();
				product_infos();
			}
			//商品模板信息
			var product_infos = function(){
				var t = _.template($("#products").html());
				$("#product_infos").html(t({shopping_infos:order.shopping_infos,products:order.products}));
				$("#amount").html("￥"+order.shopping_infos.total_price);
				$(".product_line").click(function(){
					var index = $(this).data("id")-1;
					show_one_line(index);
				});
			};
			//关闭单条信息
			$(".close").click(function(){
				$(".content").attr("style","display:none;");
			});
			//保存单条信息
			$(".save").click(function(){
				save_one_line();
			});
			//结算
			$("#pay").click(function(){
				if (order.products.length>0) {
					$("#pay_info").removeAttr("style");
					$(".pay_amount").html("应付："+order.shopping_infos.total_price);
				}else {
					alert("还没有购买商品！")
				}
			});
			//清除结算
			$(".leave").click(function(){
				init_pay_infos();
				$(".pay_table").html("");
				$("#pay_info").attr("style","display:none;");
			});
			//返回
			$(".back").click(function(){
				$("#pay_info").attr("style","display:none;");
			});
			//作废 看商品数量多少，超过10个弹出判断
			$("#clear").click(function(){
				if (order.products.length>10) {
					$(".do_clear").removeAttr("style");
				}else {
					init_product_infos();
					product_infos();
					member_update();
				}
			});
			//作废是
			$(".yes").click(function(){
				init_product_infos();
				product_infos();
				member_update();
				$(".do_clear").attr("style","display:none;");
			});
			//作废否
			$(".no").click(function(){
				$(".do_clear").attr("style","display:none;");
			});
			//点击现金
			$(".cash").click(function(){
				if (pay_way_status == 10) {
					return;
				}
				pay_way_status =0;
				pay_way_change(pay_way_status);
			});
			//付款信息表显示
			var payment_info_table = function(){
				var t = _.template($("#pay_table_infos").html());
				$(".pay_table").html(t({pay_infos:order.pay_infos,shopping_infos:order.shopping_infos}));
			};
			//付款get方法
			var get_method = function(url,params,cb){
				$.get(url,params,function(data){
					if (data.success) {
						cb(data);
					}else {
					}
				});
			};
			//输入现金
			$(".cash_value").keypress(function(e){
				var pay_amount = $(".cash_value").val();
				var key = e.which;
				if (!pay_amount || key != 13) {
					return;
				}
				pay_amount = parseFloat(pay_amount);
				$(".change").removeAttr("style");
				var change = parseFloat(0);
				change = pay_amount-order.shopping_infos.total_price;
				$(".change_value").val(change);
				order.pay_way.push("0");
				$(".print_invoice").removeAttr("style");
				//如果金额大于等于订单总计一次性保存订单，并且支付
				if (change>100) {
					alert("支付额过大");
					return;
				}
				if (change >= 0) {
					if (!order.order_id) {
						get_method("/save_order_detail",{"order":JSON.stringify(order)},function(data){
							order.order_id = data.row.order_id;
							var params = {
								"order":JSON.stringify(order),
								"store_address":store_address,
								"person_id":person_id,
								"pay_amount":pay_amount
							};
							get_method("/deal_cash_pay",params,function(data){
								add_pay_info("现金",pay_amount,data);
							});
						});
					}else {
						var params = {
							"order":JSON.stringify(order),
							"store_address":store_address,
							"person_id":person_id,
							"pay_amount":pay_amount
						};
						get_method("/deal_cash_pay",params,function(data){
							add_pay_info("现金",pay_amount,data);
						});
					}
				}else {
					//非一次性支付
					if (!order.order_id) {
						get_method("/save_order_detail",{"order":JSON.stringify(order)},function(data){
							order.order_id = data.row.order_id;
							var params = {
								"order":JSON.stringify(order),
								"store_address":store_address,
								"person_id":person_id,
								"pay_amount":pay_amount
							};
							get_method("/deal_cash_pay",params,function(data){
								add_pay_info("现金",pay_amount,data);
							});
						});
					}else {
						var params = {
							"order":JSON.stringify(order),
							"store_address":store_address,
							"person_id":person_id,
							"pay_amount":pay_amount
						};
						get_method("/deal_cash_pay",params,function(data){
							add_pay_info("现金",pay_amount,data);
						});
					}
				}
			});
			//输入会员支付号码
			$(".member_pay_card").keypress(function(e){
				var pay_amount = $(".member_value").val();
				var member_pay_card = $(".member_pay_card").val();
				var key = e.which;
				if ( !member_pay_card || key != 13) {
					return;
				}
				pay_amount = parseFloat(pay_amount);
				order.pay_way.push("3");
				var change = parseFloat(0);
				change = pay_amount-order.shopping_infos.total_price;
				//一次支付
				if (change >0) {
					alert("超过支付金额！");
					return;
				}
				if (change <= 0) {
					//一次支付，并生成订单
					if (!order.order_id) {
						get_method("/save_order_detail",{"order":JSON.stringify(order),"person_id":person_id},function(data){
							order.order_id = data.row.order_id;
							var params = {
								"order":JSON.stringify(order),
								"paycode":member_pay_card,
								"store_address":store_address,
								"person_id":person_id,
								"pay_amount":pay_amount
							};
							get_method("/deal_card_pay",params,function(data){
								add_pay_info("会员卡",pay_amount,data);
							});
						});
					}else {
						var params = {
							"order":JSON.stringify(order),
							"paycode":member_pay_card,
							"store_address":store_address,
							"person_id":person_id,
							"pay_amount":pay_amount
						};
						get_method("/deal_card_pay",params,function(data){
							add_pay_info("会员卡",pay_amount,data);
						});
					}
				}else {
					//多种支付方式
					if (!order.order_id) {

					}else {

					}
				}
			});
			//支付宝点击
			$(".alipay").click(function(){
				if (pay_way_status == 10) {
					return;
				}
				pay_way_status =1;
				pay_way_change(pay_way_status);
			});
			//会员支付点击
			$(".member_card").click(function(){
				if (pay_way_status == 10) {
					return;
				}
				pay_way_status =2;
				pay_way_change(pay_way_status);
				if (order.member) {
					$(".member_number").val(order.member.mobile);
				}else {
					$(".member_value").attr("readonly","true");
					$(".member_pay_card").attr("readonly","true");
				}

			});
			//输入会员卡点击
			$(".member").click(function(){
				$(".member_info").removeAttr("style");
			});
			//输入会员取消
			$("#member_cancel").click(function(){
				$(".member_phone").val("");
				$(".member_info").attr("style","display:none;");
			});
			//会员刷新
			var member_update = function(){
				if (order.member) {
					$(".member_name").html("姓名："+order.member.vip_name);
					$(".member_level").val(order.member.vip_type_name);
					if (!order.member.amount) {
						$(".member_amount").html("余额："+"0");
					}else {
						$(".member_amount").html("余额："+order.member.amount);
					}
					if (!order.member.integral) {
						$(".member_integral").html("积分："+"0");
					}else {
						$(".member_integral").html("积分："+order.member.integral);
					}
				}else {
					$(".member_name").html("");
					$(".member_amount").html("");
					$(".member_integral").html("");
				}

			};
			//会员号码点击
			var member_click = function(member_phone){
				$(".member_phone").val("");
				$.get("/get_member_info",{"q":member_phone},function(data){
					if (data.success) {
						bobang_success();
						order.member = data.row;
						member_update();
						$(".member_info").attr("style","display:none;");
						for (var i = 0; i < order.products.length; i++) {
							if (order.member) {
								for (var j = 0; j < order.member.discounts.length; j++) {
									if (order.member.discounts[j].org_brand_id == order.products[i].product_brand) {
										order.products[i].product_discount = order.member.discounts[j].discount;
									}
								}
							}
						}
						get_total_price();
						product_infos();
					}else {
						bobang_fail();
					}
				});
			};
			$(".member_phone").keypress(function(e){
				var member_phone = $(".member_phone").val();
				var key = e.which;
				if (member_phone && key == 13) {
					member_click(member_phone);
				}
			});
			$("#member_enter").click(function(){
				var member_phone = $(".member_phone").val();
				if (member_phone) {
					member_click(member_phone);
				}
			});

		});
	</script>
  </body>
</html>
