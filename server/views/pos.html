<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>佑佑收银平台</title>
<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
<script src="js/lodash.min.js" type="text/javascript"></script>
<script src="js/print.js" type="text/javascript"></script>
<style media="screen">
	html, body{
		color: #666;
		font:12px/1.5 Microsoft YaHei,tahoma,arial,Hiragino Sans GB,\\5b8b\4f53,sans-serif;
		background: #C8D7DB;
		background: url(images/ba_05.jpg)no-repeat 0 0;
		background-size: cover;
	}
      *{
      margin: 0;
      padding: 0
      }
      li{
        list-style: none;
      }
      a{
        text-decoration: none;
        color: #000;
      }
	  img{
		  cursor: pointer;
	  }
      .warp{
        width: 1024px;
        height: 768px;
        margin: 0 auto;
		background:#24533E;
        position: relative;

      }
      .top{
        width: 100%;
        height: 73px;
        overflow: hidden;
      }
      .top-left{
	  	width: 112px;
        text-align: center;
        margin-top: 12px;
        float: left;
      }
	  .top-left a{
		  display: inline-block;
		  padding: 2px;
		  border: 1px solid #999;
		  color: #f4f4f4;
	  }
      .top-center{
        width: 243px;
        height: 73px;
        background: url(images/title.png) no-repeat 0 0;
        background-size: contain;
        position: absolute;
        top: -6px;
        left: 43%;
        color: #fff;
        text-align: center;

      }
      .top-center span{
        display: inline-block;
        padding-top: 30px;
		padding-left: 7px;
        font-weight: 600;
        opacity: 0.8;
      }
      .top-right{
        float: right;
        margin-right: 19px;
        margin-top: 12px;
      }
	  .top-right a{
		  display: inline-block;
		  padding: 3px;
		  color: #f4f4f4;
	  }
      .top-right-left{
        width: 25px;
        height: 25px;
		display: inline-block;
      }

      /*中间部分*/
      .middle{
        width: 100%;
        height: 540px;
        overflow: hidden;
      }
      .middle-tiaoma{
		  width: 247px;
	      position: absolute;
	      bottom: 157px;
	      overflow: hidden;
	      right: 26px;
      }
      .tiaoma-left{
		  width: 42px;
	      height: 42px;
	      background: url(images/tiaoxingma.png) no-repeat 0 0;
	      background-size: cover;
	      display: inline-block;
	      vertical-align: middle;

      }
      .tiaoma-right{
		  margin-top: -2px;
	      width: 74%;
	      height: 22px;
	      display: inline-block;
	      outline: none;
	      -webkit-appearance: none;
	      vertical-align: middle;
	      border: none;
	      padding: 10px 0;
		  background: url(images/tiaoma2.png) no-repeat 0 0;
	      background-size: cover;
		  text-indent: 15px;
		  color: #fff;
      }
	  input::-webkit-input-placeholder {
		  color:#fff;
		  text-indent: 15px;
      }
      input:-moz-placeholder {
          color:#fff;
		  text-indent: 15px;
      }

      .middle-product{
        width: 944px;
        height: 470px;
        background: #DDE6FA;
        margin: 0 auto;
		border: 1px solid #4c7be3;
      }
      .product-infor{
		width: 196px;
        margin-top:10px;
        margin: 10px 15px 0;
        display: inline-block;
		border: 1px solid #4C7BE3;
      }

      .product-infor p{
        width: 170px;
		max-height: 41px;
        margin: 0 auto;
        font-size: 12px;
        padding-bottom: 5px;
        color: #6d40ae;
		margin-top: 3px;
		overflow:hidden;
		text-overflow:ellipsis;
		display:-webkit-box;
		-webkit-box-orient:vertical;
		-webkit-line-clamp:2;



      }
      .product-img{
        margin: 0 auto;
		text-align: center;
      }
      .product-img img{
		  margin-top: 10px;
          width: 180px;
          height: 180px;
      }
      .product-infor span:first-child{
        font-size: 16px;
        color: #666;
        margin-left: 9px;
      }
      .product-infor span:last-child{
        font-size:16px;
        color: #FF0000;
        float: right;
        margin-right: 23px;
      }
      .product-conver{
        /*display: none;*/
        width: 100%;
        margin: 0 auto;
        overflow: auto;
        height: 470px;
	    /*background: url(images/135178199510146468.jpg);*/
      }
     /*底                部*/
     .footer{
       overflow: hidden;
     }
     .footer-left{
       width: 152px;
       height: 144px;
       float: left;
	   background: url(images/shouyinqiang.png)no-repeat 0 0;
	   background-size: contain;
	       margin-left: 7.5px;
     }
     .footer-left p{
       font-size: 12px;
       font-weight: 400;
	   text-indent: 11px;
       line-height: 24px;
       color: #000;
	   font-weight: 600;
    }
    .footer-left p:first-child{
      margin-top: 68px;
    }
    .footer-center{
      width: 690px;
      height: 130px;
      float: left;
	  margin-left: 15px;
    }
    .footer-center-nav{
      display: flex;
      margin-top: 44px;
    }
    .footer-center-nav li{
      flex: 1;
    }
    .nav-infor{
      width: 79px;
      height:64px;
      margin: 0 auto;
    }
    .footer-center-nav li p{
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
    }
    .nav-infor img{
      width: 69px;
      height:59px;
    }
    .footer-right{
      float: right;
      width: 152px;
      height: 144px;
	  cursor: pointer;
	  background: url(images/shouyinqiang.png)no-repeat 0 0;
	  background-size: contain;
	  margin-right: 7.5px;
    }
    .footer-right p{
      color: #fff;
	  margin-left: 10px;
    }
    .footer-right p:first-child{
		width: 76%;
      margin-top: 78px;
      font-size: 16px;
      font-weight: 600;
	  white-space:normal;
	  word-break:break-all;
    }
    .footer-right p:last-child{
        margin-top: 17px;
        font-size: 14px;
        text-align: center;
    }
    .ma-num{
      display: inline-block;
      padding-top: 10px;
	  padding-bottom: 10px;
      margin-left: 40px;
      color: #000;
    }
	.weui_mask {
		position: fixed;
		z-index: 10;
		width: 100%;
		height: 100%;
		top: 0;
		left: 0;
		background: rgba(0, 0, 0, 0.6);
	}
	.weui_dialog {
		position: fixed;
		z-index: 13;
		width: 380px;
    	height: 180px;
		top: 47%;
		left: 50%;
		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
		border-radius: 3px;
		overflow: hidden;
		background: url(images/price_num.jpg)no-repeat 0 0;
  	  	background-size: cover;
	}
	.curr{
		/*background: #dedede;*/
	}
	.get_member{
		height: 75px;
	    margin: 30px;
	    font-size: 24px;
	}
	.member_phone{
		margin-left: 12px;
		width: 254px;
		padding: 2px;
		height: 24px;
		font-size: 16px;
	}
	.member_button{
		width: 94px;
	    font-size: 16px;
	    height: 30px;
	    float: left;
	    line-height: 30px;
	    border: 1px solid #CECECE;
	    margin-left: 52px;
	    cursor: pointer;
	    text-align: center;
	}
	.weui_dialog2 {
		position: fixed;
		z-index: 13;
		width: 540px;
		top: 50%;
		left: 53%;
		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
		background-color: #FAFAFC;
		border-radius: 3px;
		overflow: hidden;
	}
	#guadan_info{
		height:600px;
		width:100%;

	}
	.hover{
		border:1px solid red;
	}
	.pay_table{
		margin: 20px auto;
	}
	table.pay_way_infos {
		font-family: verdana,arial,sans-serif;
		font-size:11px;
		color:#333333;
		border-width: 1px;
		border-color: #666;
		border-collapse: collapse;
		width: 98%;
		margin: 0 auto;
	}
	table.pay_way_infos th {
		border-width: 1px;
		padding: 3px;
		border-style: solid;
		border-color: #666666;
		background-color: #dedede;
		font-size: 16px;
	}
	table.pay_way_infos td {
		border-width: 1px;
		padding: 8px;
		border-style: solid;
		border-color: #666666;
		background: #F7F7F7;
		font-size: 14px;
	}
	.table_flow{
		overflow: auto;
	}
	.product-infor.product_line.imgAnimation.curr{
		 animation-name: imgAnimation;
		 animation: imgAnimation 1s alternate;
		 -webkit-animation: imgAnimation 1s alternate;
		 /*-moz-animation: imgAnimation 1s alternate;*/
		 border:1px solid red;
		 background: #F1F5FD;
	}
	@-webkit-keyframes imgAnimation{
		0%{ opacity: 0}
		50%{ opacity: 0.5}
		100%{ opacity: 1}
	}
	@-moz-keyframes imgAnimation{
		0%{ opacity: 0}
		50%{ opacity: 0.5}
		100%{ opacity: 1}
	}
	.close{
		float:right;
		height:100%;
		width:16px;
		font-size:16px;
		cursor: pointer;
		color: #fff;
	}
	#update_name{
		font-size: 16px;
		margin-left: 20px;
		color: #fff;
	}
	.update_data{
		margin-left: 57px;
		width: 111px;
		border: 3px solid #996C33;
		border-radius: 4px;
		height: 20px;
		margin-top: 10px;
	}
	.update_data1{
		margin-left: 23px;
		width: 111px;
		border: 3px solid #996C33;
		border-radius: 4px;
		height: 20px;
		margin-top: 10px;
	}
	.update_button{
		float: right;
		height: 30px;
		font-size: 18px;
		line-height: 30px;
		width: 60px;
		text-align: center;
		background: #ffbd0f;
		color: white;
		font-weight: 500;
		border-radius: 6px;
		margin-right: 90px;
		cursor: pointer;
	}
	.update_button1{
		float: left;
		height: 30px;
		font-size: 18px;
		line-height: 30px;
		width: 60px;
		text-align: center;
		background: #00ff00;
		color:white;
		font-weight: 500;
		border-radius: 6px;
		margin-left: 85px;
		cursor: pointer;
	}
	.weui_dialog3 {
		position: fixed;
		z-index: 13;
		width: 896px;
		top: 50%;
		left: 53%;
		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
		background-color: #FAFAFC;
		border-radius: 3px;
		overflow: hidden;
		width: 370px;
		height: 200px;
		background: url(images/vip_alert.png)no-repeat 0 0;
  	  	background-size: contain;
	}
	.get_member span{
		color: #2172AE;
	}
	.pay_img{
		float:left;
		margin: 15px 24px;
	}
	.pay_img2{
		float:left;
		margin: 5px 24px;
	}
	.weui_dialog4 {
		position: fixed;
		z-index: 13;
		width: 300px;
		height: 400px;
		top: 50%;
		left: 50%;
		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
		background-color: #FAFAFC;
		border-radius: 3px;
		overflow: hidden;
		background: transparent;
	}
	.guadan_top{
		background: url(images/guadan01.png) no-repeat;
		background-size:100% 100%;
		height: 70px;
	}
	.guadan_body{
		background: url(images/guadan02.png) no-repeat;
		background-size:100% 100%;
		height: 350px;
		overflow: hidden;
    	padding: 0 12px;
	}
	.guadan01{
		font-size:12px;
		line-height:14px;
		width: 40%;
		display: inline-block;
	}
	.guadan02{
		font-size:14px;
		line-height:14px;
		width: 17%;
		display: inline-block;
		vertical-align: top;
	}
	.guadan03{
		font-size:14px;
		line-height:14px;
		width: 40%;
		display: inline-block;
		vertical-align: top;
	}
	.back_product_info{
		position: absolute;
    	top: 46px;
    	left: 20px;
	}
	.weui_dialog5 {
		position: fixed;
		z-index: 13;
		width: 255px;
		top: 40%;
		left: 50%;
		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
		border-radius: 3px;
		overflow: hidden;
		background-color: white;
	}
	.print_content {
		width: 255px;
	}
	.logo{
		font-size: 20px;
		margin: 25px 10px 10px;
	}
	.normal{
		font-size: 12px;
		margin: 1px 12px;
	}
	.print_content span{
		display: inline-block;
	}
	.pp_info{
		margin-top: 10px;
	}
	img.num_rank{
		width: 17px;
		height: 17px;
		position: absolute;
	}

	.margin_right{
		margin-right:35px;
		    font-size: 14px;
	}
	.padding_top{
		padding-top: 24px;
	}
	.back{
		padding: 3px 5px;
		background: #58C3E5;
		border-radius: 2px;
		color: #fff;
		cursor: pointer;
	}
	.span_width{
		display: inline-block;
		width: 305.14px;
	}
	.span_width1{
		display: inline-block;
		width: 209.14px;
	}
	.span_width2{
		display: inline-block;
    	width: 249.14px;
	}
	.leave{
		color: #fff;
    	background-color: #286090;
    	border-color: #204d74;
		padding: 12px 50px;
	    font-size: 12px;
	    line-height: 1.5;
	    border-radius: 3px;
		display: inline-block;
		font-weight: 400;
		text-align: center;
    	white-space: nowrap;
    	vertical-align: middle;
		touch-action: manipulation;
    	cursor: pointer;
		margin-bottom: 7px;
	}
	.cash_value{
		width: 110px;
	    border: 1px solid #999;
	}
	.print{
		color: #fff;
    	background-color: #00A9F2;
		border-color: #00A9F2;
		padding: 12px 50px;
	    font-size: 12px;
	    line-height: 1.5;
	    border-radius: 3px;
		display: inline-block;
		font-weight: 400;
		text-align: center;
    	white-space: nowrap;
    	vertical-align: middle;
		touch-action: manipulation;
    	cursor: pointer;
		margin-bottom: 7px;
	}.print_content {
		width: 255px;
	}
	.logo{
		font-size: 20px;
		margin: 25px 10px 10px;
	}
	.normal{
		font-size: 12px;
		margin: 1px 12px;
	}
	.normal:last-child{
		margin-bottom: 20px;
	}
	.print_content span{
		display: inline-block;
	}
	.pp_info{
		margin-top: 10px;
	}
	.num_rank{
		width: 17px;
	    height: 17px;
	    display: inline-block;
	    background: red;
	    text-align: center;
	    line-height: 17px;
	    border-radius: 50%;
	    color: #fff;
	    position: absolute;
	}
			/*退款*/
	.refund{
		color: #000;
    	background-color: #ddd;
		border-color: #999;
		padding: 12px 50px;
	    font-size: 12px;
	    line-height: 1.5;
	    border-radius: 3px;
		display: inline-block;
		font-weight: 400;
		text-align: center;
    	white-space: nowrap;
    	vertical-align: middle;
		touch-action: manipulation;
    	cursor: pointer;
		margin-bottom: 7px;
		display: none;
	}
	.cash_value{
		font-size: 24px;
	}

	.alipay_value{
		font-size: 24px;
		width: 85px;
		border: 1px solid #666;
	}
	.alipay_code{
		width: 106px;
		border: 1px solid #666;
	}
	.ali_transfer_value{
		font-size: 24px;
		width: 85px;
		border: 1px solid #666;
	}
</style>
</head>
  <body class="body">
	<div class="member_info" style="display:none;">
	  <div class="weui_mask"></div>
	  <div class="weui_dialog3">
		  <div class="get_member">
			  <span>会员卡号：</span> <input class="member_phone" type="text" value="" placeholder="请输入会员卡号/手机号"/>
		  </div>
		  <div>
			  <div class="member_button" id="member_enter">确定</div>
			  <div class="member_button" id="member_cancel">取消</div>
		  </div>
	  </div>
	</div>
	<div class="content" style="display:none;">
	  <div class="weui_mask"></div>
	  <div class="weui_dialog">
		  <div style="width:100%;height:20px" >
			  <div class="close">X</div>
		  </div>
		  <div style="width:100%;height:70px">
			  <div id="update_name"></div>
		  </div>
		  <div style="width:100%;height:50px;">
			   <input id="update_price" class="update_data" value=""/>
			   <input id="update_number" class="update_data1" value=""/>
		  </div>
		  <div style="width:100%;height:40px">
			  <div class="save update_button">保存</div>
			  <div class="delete update_button1">删除</div>
		  </div>
		  <div></div>
		  <input id="update_id" value="" style="display:none;"/>
	  </div>
	</div>
	<div id="pay_info" style="display:none;">
		<div class="weui_mask"></div>
		<div class="weui_dialog2">
			<div style="width:100%;">
				<div style="width:500px;margin:0 auto">
					<img src="/images/pay01.png" class="pay_img cash"/>
					<img src="/images/pay03.png" class="pay_img"/>
					<img src="/images/pay02.png" class="pay_img alipay"/>
					<img src="/images/pay04.png" class="pay_img2 member_card"/>
					<!-- <img src="/images/pay05.png" class="pay_img2 credit"/>
					<img src="/images/pay06.png" class="pay_img2"/> -->

					<!-- <img src="/images/pay05.png" class="pay_img" />
					<img src="/images/pay06.png" class="pay_img" /> -->
					<img src="/images/pay07.png" class="pay_img2 ali_transfer"/>
					<img src="/images/pay08.png" class="pay_img2 weixin_transfer"/>
					<div style="clear:both;"></div>
					<div style="margin-left:24px;" class="padding_top">
						<span class="pay_amount margin_right"></span>
						<span class="cash_pay margin_right span_width2" style="display:none;">
							现金：<input class="cash_value" type="text" value=""/>
						</span>
						<span class="alipay_pay span_width" style="display:none;">
							支付宝 ：<input class="alipay_value" type="text" value="" data-id="1"/>
							支付码 ：<input class="alipay_code" type="text" value="" />
						</span>
						<span class="member_pay margin_right span_width" style="display:none;">
							卡号：<input class="member_number" type="text" value="" placeholder="会员还未登记！" readonly style="width:90px;"/>
							<span style="margin-left:20px;">金额：</span><input class="member_value" type="text" value="" style="width:90px;"/>
							<span style="margin-left:20px;">支付码：</span><input class="member_pay_card" type="text" value="" style="width:90px;"/>
						</span>
						<!-- <span class="credit_pay margin_right span_width" style="display:none;">
							白条：<input class="credit_value" type="text" value=""/>
						</span> -->
						<span class="ali_transfer_pay span_width" style="display:none;">
							支付宝转账：<input class="ali_transfer_value" type="text" value=""/>
						</span>
						<span class="weixin_transfer_pay margin_right span_width1" style="display:none;">
							微信转账：<input class="weixin_transfer_value" type="text" value=""/>
						</span>
						<span class="pay_more margin_right span_width" style="display:none;">
							<span>支付完成！</span>
						</span>
						<!-- <span class="choose_pay margin_right span_width" style="display:none;">
							请选择其他支付方式
						</span> -->
						<span class="back" style="width: 50px;">返回</span>
					</div>
				</div>
				<div class="pay_table">
				</div>
				<div class="" style="text-align:center">
					<button class="leave">确 认</button>
					<button class="refund">退 款</button>
					<input class="print" type="button" value="打印" style="display:none;"/>
				</div>
			</div>
		</div>
	</div>
	<script id="pay_table_infos" type="text/template">
		<table class="pay_way_infos">
			<tr>
				<th>序号</th><th>方式</th><th>金额</th><th colspan="2">流水号</th>
			</tr>
			<div class="table_flow">
				<% _.forEach(pay_infos, function(pay_info,index) { %>
					<tr>
						<td><%- index+1 %></td>
						<td><%- pay_info.pay_way %></td>
						<td><%- pay_info.pay_amount %></td>
						<td colspan="2"><%- pay_info.fin %></td>
					</tr>
				<% }); %>
			</div>
			<tr>
				<th>总付</th><th>已付</th><th>待付</th><th>抹零</th><th>找零</th>
			</tr>
			<tr>
				<td><%- shopping_infos.total_price %></td>
				<td><%- shopping_infos.ready_pay %></td>
				<td><%- shopping_infos.pre_pay %></td>
				<td><%- shopping_infos.small_change %></td>
				<td><%- shopping_infos.changes %></td>
			</tr>
		</table>
	</script>
	<div class="do_clear" style="display:none;">
		<div class="weui_mask"></div>
		<div class="weui_dialog">
			<div style="height:100px;">
				<div class="yes" style="border:1px solid #000;width:47%;margin:1%;float:left;">是</div>
				<div class="no" style="border:1px solid #000;width:48%;margin:1%;float:left;">否</div>
			</div>
		</div>
	</div>
	<div class="warp">
      <div class="top">
        <div class="top-left"><a href="/logout">退出</a></div>
        <div class="top-center"><span><u>{{store_info[0].point_name}}</u></span></div>
        <div class="top-right">
			<span><a>操作员:{{person_info.person.person_code}}</a></span>
        </div>
      </div>
      <div class="middle">

        <div class="middle-tiaoma">
          <div class="tiaoma-left"></div>
          <input type="text" name="" value="" class="tiaoma-right" style="padding-left: 5px;" id="barcode" placeholder="条形码">
        </div>

        <!-- 商品显示 -->
        <div class="middle-product">
          <ul class="product-conver" id="product_infos">
          </ul>
        </div>
      </div>
      <div class="footer">
        <div class="footer-left">
          <p class="member_name"></p>
          <p class="member_integral"></p>
          <p class="member_amount"></p>
        </div>
        <div class="footer-center">
          <ul class="footer-center-nav">
            <li>
              <div class="nav-infor member">
                <div class="nav-img">
                  <img src="images/vip_num.png" alt="">
                </div>

              </div>
              <p>会员卡</p>
            </li>
            <li>
              <div class="nav-infor" id="put_order">
                <div class="nav-img" >
                  <img src="images/guadan1.png" alt="">
                </div>
              </div>
              <p>挂单</p>
            </li>
            <li>
              <div class="nav-infor" id="get_order">
                <div class="nav-img">
                  <img src="images/qudan1.png" alt="">
                </div>
              </div>
              <p>取单</p>
            </li>
            <li>
              <div class="nav-infor" id="clear">
                <div class="nav-img">
                  <img src="images/zuofei.png" alt="">
                </div>
              </div>
              <p>作废</p>
            </li>
            <li>
              <div class="nav-infor">
                <div class="nav-img">
                  <img src="images/qianxiang.png" alt="">
                </div>
              </div>
              <p>弹出钱箱</p>
            </li>

          </ul>
        </div>
        <div class="footer-right" id="pay">
          <p><u id="amount" style="color:#000;font-size:24px;">￥0.00</u></p>
          <p></p>
        </div>
      </div>
    </div>
	<div id="guadan" style="display:none;">
		<div class="weui_mask"></div>
		<div class="weui_dialog4">
			<div id="guadan_info">
			</div>
		</div>
	</div>
	<div id="receipt_infos" style="display:none;">
		<div class="weui_mask"></div>
		<div class="weui_dialog5">
			<div class="print_content">
				<div class="logo">
					善淘慈善商店
				</div>
				<div class="normal">{{store_info[0].point_name}}</div>
				<div class="normal">电话：{{store_info[0].tel}}</div>
				<div class="normal">地址：{{store_info[0].detail_address}}</div>
				<div class="normal">
					<span style="width:63%;">收营员：{{person_info.person.person_code}}</span>
					<span style="width:35%;">序：12345678</span>
				</div>
				<div id="print_receipt_info">

				</div>
			</div>
		</div>
	</div>
	<audio class="success"><source src="js/7499.wav" type="audio/wav"></audio>
	<audio class="fail"><source src="js/3.wav" type="audio/wav"></audio>
	<script id="qudan" type="text/template">
		<div class="guadan_top">
			<div>
				<input type="button" value="返回" class="back_product_info"/>
			</div>
			<div style="padding: 45px 0 5px 110px;font-size:20px;line-height:20px;">挂单信息</div>
		</div>
		<div class="guadan_body">
			<% _.forEach(temp_products, function(order,index) { %>
			<div style="padding: 5px;text-align: center;">
				<!-- <p style="display: inline-block;"><%- index+1 %>.</p>&nbsp;&nbsp;&nbsp; -->
				<p  style="display: inline-block;">时间：<%- order.guadan_time %></p>
			</div>
			<div style="padding: 5px;text-align: center;">
				<P class="guadan01">商品名称</P>
				<p class="guadan02">价格</P>
				<P class="guadan03">数量</P>
			</div>
			<div class="qudan_line" data-id="<%- index %>">
				<% _.forEach(order.products, function(product) { %>
					<div style="padding: 5px;text-align: center;">
						<span class="guadan01"><%- product.product_name %></span>
						<span class="guadan02">￥<%- product.product_price %></span>
						<span class="guadan03"><%- product.product_number %></span>
					</div>
				<% }); %>
			</div>
			<% }); %>
		</div>
	</script>
	<script id="products" type="text/template">
		<% _.forEach(products, function(product,index) { %>
			<li class="product-infor product_line imgAnimation" data-id="<%- index+1 %>" id="<%- product.barcode %>">
              <div class="product-img">	<% if (product.delay) { %><img src="<%- product.picture %>" alt="" class="<%- product.barcode %>"><% }else{ %><img src="/images/delay.gif" alt="" class="<%- product.barcode %>" data-src="<%- product.picture %>" style="width:62px;height:62px;padding-top:50px;"> <% } %></div>
              <p><%- product.product_name %>
				  <% _.forEach(product.sale_properties, function(sale_property) { %>
					  <% if (product.stock_options[sale_property.field_name]) { %>
					  	<%- sale_property.name %>:<%- product.stock_options[sale_property.field_name] %>
					  <% } %>
			      <% }); %>
			  </p>
              <div class="price" style="margin-top:-5px;">
				<% if (product.product_discount ==1) { %>
					<span>￥<%- product.product_price %></span>
				<% }else { %>
					<span>￥<%- product.discount_product_price %></span>
				<% } %>
				<% if (product.product_discount !=1) { %>
					<span style="margin-left:15px;"><%- product.product_discount %>折</span>
				<% } %>
				<span><%- product.product_number %></span>
              </div>
            </li>

		<% }); %>
	</script>
	<script id="print_receipt_infos" type="text/template">
		<div class="normal">
			<span style="width:63%;"><%- print_infos.order.order_date_text %></span>
			<span style="width:35%;">机：<%- print_infos.order.pos_id %></span>
		</div>
		<div class="pp_info">
			<% _.forEach(print_infos.order_details, function(order_detail,index) { %>
			<div class="normal">
				<span style="width:50%;vertical-align: middle;"><%- order_detail.product.product_name %></span>
				<span style="width:26%;"><%- order_detail.price %>X<%- order_detail.number %></span>
				<span style="width:20%;text-align:right;"><%- order_detail.price*order_detail.number %></span>
			</div>
			<% }); %>
		</div>
		<% _.forEach(print_infos.pay_infos, function(pay_info,index) { %>
			<div class="pp_info">
				<div class="normal"><%- pay_info.pay_way %>：<%- pay_info.pay_amount %></div>
				<!-- <div class="normal">支付宝账号:182****6882</div> -->
				<div class="normal">流水号：</div>
				<div class="normal"><%- pay_info.pay_log_id %></div>
			</div>
		<% }); %>
		<div class="pp_info">
			<div class="normal">
				<span style="width:26%">商品小计：</span>
				<span style="width:20%;text-align:right;"><%- print_infos.order.marketing_price %></span>
				<!-- <span style="width:25%;text-align:center;">现&nbsp;&nbsp;&nbsp;金：</span>
				<span style="width:23%;text-align:right;">0.00</span> -->
			</div>
			<!-- <div class="normal">
				<span style="width:26%"></span>
				<span style="width:20%;text-align:right;"></span>
				<span style="width:25%;text-align:center;">支付宝：</span>
				<span style="width:23%;text-align:right;">14.40</span>
			</div> -->
			<div class="normal">
				<span style="width:26%">折扣合计：</span>
				<span style="width:20%;text-align:right;"><%- print_infos.order.card_reduce %></span>
			</div>
			<div class="normal">
				<span style="width:26%">分头舍去</span>
				<span style="width:20%;text-align:right;"><%- print_infos.order.small_change %></span>
			</div>
			<div class="normal">
				<span style="width:26%">金额合计：</span>
				<span style="width:20%;text-align:right;"><%- print_infos.order.actual_price %></span>
				<span style="width:25%;text-align:center;">找&nbsp;&nbsp;&nbsp;零：</span>
				<span style="width:23%;text-align:right;"><%- print_infos.order.changes %></span>
			</div>
		</div>
		<div class="normal">感谢光临善淘慈善店，期待您的下次光临</div>
	</script>
	<script>
		$(function() {
			var store = "{{store_info[0].point_name}}";
			var store_id = "{{store_info[0].store_id}}"
			var store_address = "{{store_info[0].detail_address}}";
			var person_id = "{{person_info.person_id}}";
			var order = {
				"shopping_infos" : {
					"total_price":parseFloat(0.00),
					"total_discount":parseFloat(0),
					"payway_price":parseFloat(0.00),
					"marketing_price":parseFloat(0),
					"ready_pay" : parseFloat(0),
					"pre_pay" : parseFloat(0),
					"cash_pay" : parseFloat(0),
					"changes" : parseFloat(0),
					"small_change" : parseFloat(0)
				},
				"member" : null,
				"products" : [],
				"pay_way" : [],
				"order_id" : null,
				"fin" : null,
				"pay_infos" : [],
				"store_id":null
			};
			var cnt =0;
			var ali_id;
			//挂单用的临时变量
			var temp_products = [];
			//回到商品扫描
			var comefocus = function(){
				$("#barcode").focus();
			};
			comefocus();
			//支付方式选择
			var pay_way_status = 0; //现金 0，支付宝 1，会员卡 2, 挂单 3，付款超额 10
			var pay_way_change = function(pay_way_status){
				$(".pay_amount").html("应付："+order.shopping_infos.total_price);
				if (pay_way_status != 10) {
					order.shopping_infos.small_change = 0;
				}
				if (pay_way_status == 0) {
					if (!order.shopping_infos.ready_pay) {
						var payway_price = parseFloat(parseInt(order.shopping_infos.total_price*10)/10);
						order.shopping_infos.payway_price = payway_price;
						order.shopping_infos.small_change = order.shopping_infos.total_price - payway_price;
						order.shopping_infos.small_change = parseFloat(order.shopping_infos.small_change.toFixed(2));
					} else {
						order.shopping_infos.payway_price = order.shopping_infos.total_price;
					}
					order.shopping_infos.pre_pay = parseFloat((order.shopping_infos.payway_price -  order.shopping_infos.ready_pay).toFixed(2));
					$(".cash_value").val(order.shopping_infos.pre_pay);
					$(".pay_amount").html("应付："+order.shopping_infos.total_price);
					$(".alipay_pay").attr("style","display:none;");
					$(".member_pay").attr("style","display:none;");
					$(".pay_more").attr("style","display:none;");
					$(".credit_pay").attr("style","display:none;");
					$(".choose_pay").attr("style","display:none;");
					$(".ali_transfer_pay").attr("style","display:none;");
					$(".weixin_transfer_pay").attr("style","display:none;");
					$(".cash_pay").removeAttr("style");
					$(".cash_value").focus();
				}else if (pay_way_status == 1) {
					order.shopping_infos.pre_pay = parseFloat((order.shopping_infos.total_price -  order.shopping_infos.ready_pay).toFixed(2));
					$(".alipay_value").val(order.shopping_infos.pre_pay);
					$(".member_pay").attr("style","display:none;");
					$(".cash_pay").attr("style","display:none;");
					$(".pay_more").attr("style","display:none;");
					$(".credit_pay").attr("style","display:none;");
					$(".choose_pay").attr("style","display:none;");
					$(".ali_transfer_pay").attr("style","display:none;");
					$(".weixin_transfer_pay").attr("style","display:none;");
					$(".alipay_pay").removeAttr("style");
					$(".alipay_code").focus();
				}else if (pay_way_status == 2) {
					order.shopping_infos.pre_pay = parseFloat((order.shopping_infos.total_price -  order.shopping_infos.ready_pay).toFixed(2));
					$(".member_value").val(order.shopping_infos.pre_pay);
					$(".alipay_pay").attr("style","display:none;");
					$(".cash_pay").attr("style","display:none;");
					$(".pay_more").attr("style","display:none;");
					$(".credit_pay").attr("style","display:none;");
					$(".choose_pay").attr("style","display:none;");
					$(".ali_transfer_pay").attr("style","display:none;");
					$(".weixin_transfer_pay").attr("style","display:none;");
					$(".member_pay").removeAttr("style");
					$(".member_pay_card").focus();
				}else if (pay_way_status == 3) {
					order.shopping_infos.pre_pay = parseFloat((order.shopping_infos.total_price -  order.shopping_infos.ready_pay).toFixed(2));
					$(".credit_value").val(order.shopping_infos.pre_pay);
					$(".alipay_pay").attr("style","display:none;");
					$(".cash_pay").attr("style","display:none;");
					$(".pay_more").attr("style","display:none;");
					$(".member_pay").attr("style","display:none;");
					$(".choose_pay").attr("style","display:none;");
					$(".ali_transfer_pay").attr("style","display:none;");
					$(".weixin_transfer_pay").attr("style","display:none;");
					$(".credit_pay").removeAttr("style");
					$(".credit_value").focus();
				}else if (pay_way_status == 4) {
					$(".ali_transfer_value").val(order.shopping_infos.pre_pay);
					$(".alipay_pay").attr("style","display:none;");
					$(".cash_pay").attr("style","display:none;");
					$(".pay_more").attr("style","display:none;");
					$(".member_pay").attr("style","display:none;");
					$(".choose_pay").attr("style","display:none;");
					$(".credit_pay").attr("style","display:none;");
					$(".weixin_transfer_pay").attr("style","display:none;");
					$(".ali_transfer_pay").removeAttr("style");
					$(".ali_transfer_value").focus();
				}else if (pay_way_status == 5) {
					$(".weixin_transfer_value").val(order.shopping_infos.pre_pay);
					$(".alipay_pay").attr("style","display:none;");
					$(".cash_pay").attr("style","display:none;");
					$(".pay_more").attr("style","display:none;");
					$(".member_pay").attr("style","display:none;");
					$(".choose_pay").attr("style","display:none;");
					$(".ali_transfer_pay").attr("style","display:none;");
					$(".credit_pay").attr("style","display:none;");
					$(".weixin_transfer_pay").removeAttr("style");
					$(".weixin_transfer_value").focus();
				}else if (pay_way_status == 10) {
					$(".member_pay").attr("style","display:none;");
					$(".alipay_pay").attr("style","display:none;");
					$(".cash_pay").attr("style","display:none;");
					$(".credit_pay").attr("style","display:none;");
					$(".choose_pay").attr("style","display:none;");
					$(".ali_transfer_pay").attr("style","display:none;");
					$(".weixin_transfer_pay").attr("style","display:none;");
					$(".pay_more").removeAttr("style");
				}
			};
			//清除支付信息
			var init_pay_infos = function(){
				pay_way_status = 0;
				pay_way_change(pay_way_status);
				order = {
					"shopping_infos" : {
						"total_price":parseFloat(0),
						"total_discount":parseFloat(0),
						"marketing_price":parseFloat(0),
						"ready_pay":parseFloat(0),
						"pre_pay":parseFloat(0),
						"cash_pay" : parseFloat(0),
						"changes" : parseFloat(0),
						"small_change" : parseFloat(0)
					},
					"member" : null,
					"products" : [],
					"pay_way" : [],
					"order_id" : null,
					"fin" : null,
					"pay_infos" : []
				};
				payment_info_table();
				product_infos();
				member_update();
				$(".cash_value").val("");
				$(".member_number").val("");
				$(".member_value").val("");
				$(".member_pay_card").val("");
				$(".alipay_value").val("");
				$(".alipay_code").val("");
				$(".credit_value").val("");
				// $(".pay_table").html("");
			};
			//初始产品信息
			var init_product_infos = function(){
				order = {
					"shopping_infos" : {
						"total_price":parseFloat(0.00),
						"total_discount":parseFloat(0),
						"marketing_price":parseFloat(0),
						"ready_pay" : parseFloat(0),
						"pre_pay" : parseFloat(0),
						"cash_pay" : parseFloat(0),
						"changes" : parseFloat(0),
						"small_change" : parseFloat(0)
					},
					"member" : null,
					"products" : [],
					"pay_way" : [],
					"order_id" : null,
					"fin" : null,
					"pay_infos" : []
				};
				product_infos();
				$("#barcode").val("");
				$(".leave").removeAttr("disabled");
				$(".alipay_value").removeAttr("disabled");
			};
			//添加付记录
			var add_pay_info = function(pay_way,pay_amount,data){
				var pay_infos = {};
				pay_infos.pay_amount = pay_amount;
				pay_infos.pay_way = pay_way;
				pay_infos.fin = data.row.pay_log_id;
				order.pay_infos.push(pay_infos);
				var ready_pay = 0;
				var pre_pay = 0;
				for (var i = 0; i < order.pay_infos.length; i++) {
					ready_pay = ready_pay + order.pay_infos[i].pay_amount;
				}
				ready_pay = parseFloat(parseInt(ready_pay*100)/100);
				pre_pay = order.shopping_infos.total_price - ready_pay - order.shopping_infos.small_change;
				pre_pay = pre_pay.toFixed(2);
				order.shopping_infos.ready_pay = ready_pay;
				order.shopping_infos.pre_pay = pre_pay;
				if (order.shopping_infos.pre_pay <= 0) {
					order.shopping_infos.pre_pay = 0;
					pay_way_status = 10;
					pay_way_change(pay_way_status);
					var changes = order.shopping_infos.ready_pay-order.shopping_infos.total_price+order.shopping_infos.small_change;
					changes = parseFloat(changes.toFixed(2));
					order.shopping_infos.changes = changes;
				}
				payment_info_table();
			};
			//挂单小数字标记
			var small_number = function(){
				var num = temp_products.length;
				if (num == 0) {
					$("#put_order").children(".nav-img").children(".num_rank").remove();
					return;
				}
				$("#put_order").children(".nav-img").children(".num_rank").remove();
				$("#put_order").children(".nav-img").append("<span class='num_rank'>"+num+"</span>");
			};
			//挂单
			$("#put_order").click(function(){
				if (order.products.length >0 && temp_products.length < 3) {
					order.guadan_time = new Date().toLocaleString();
					temp_products.push(order);
					init_product_infos();
					member_update();
					small_number();
				}else if (order.products.length >0 && temp_products.length >= 3) {
					alert("挂单已满");
				}
				else {
					alert("无单可挂");
				}
			});
			//取单
			$("#get_order").click(function(){
				if (temp_products.length >0) {
					$("#guadan").removeAttr("style");
					guadan_info();
				}else {
					alert("无单可取");
				}
			});
			//挂单信息
			var guadan_info = function(){
				var t = _.template($("#qudan").html());
				$("#guadan_info").html(t({temp_products:temp_products}));
				$(".qudan_line").hover(
					function () {
						$(this).addClass("hover");
					},
					function () {
						$(this).removeClass("hover");
					}
				);
				$(".qudan_line").click(function(){
					var index = $(this).data("id");
					order = temp_products[index];
					product_infos();
					get_picture();
					member_update();
					temp_products.splice(index,1);
					$("#barcode").val("");
					$("#guadan").attr("style","display:none;");
					small_number();
				});
				$(".back_product_info").click(function(){
					$("#guadan").attr("style","display:none;");
				});
			};
			//商品高亮
			var highlight = function(id){
				$("#"+id).removeClass("curr");
				$("#"+id).addClass("curr");
				$('div,ul').animate({scrollTop:$('#'+id).offset().top}, 800);
				// $("."+id).removeAttr("style");
			};
			//扫描条形码
			$("#barcode").keypress(function(e){
				var barcode = $("#barcode").val();
				var key = e.which;
				if (barcode && key == 13) {
					$("#barcode").val("");
					$.get("/get_product_info",{"barcode":barcode},function(data){
						if (data.success) {
							bobang_success();
							var product ={};
							product.product_id = data.row.id;
							product.product_code = data.row.code;
							product.product_name = data.row.product_name;
							product.product_price = data.row.product_sale_price;
							product.product_stock = data.stocks;
							product.product_color = data.row.color;
							product.product_number = 1;
							product.product_brand = data.row.product_brand;
							product.product_discount = 1;
							product.picture = data.picture_info.location;
							if (product.picture == null) {
								product.picture = "no_picture.png";
							}
							product.sale_properties = data.sale_properties;
							product.discount_product_price = product.product_price;
							product.stock_options = data.stock_options;
							if (!product.picture) {
								product.picture = "delay.gif";
							}
							product.barcode = barcode;
							var add = true;
							for (var i = 0; i < order.products.length; i++) {
								if (order.products[i].barcode == product.barcode) {
									order.products[i].product_number = order.products[i].product_number +1;
									add = false;
									break;
								}
							}
							if (add) {
								order.products.push(product);
							}
							get_total_price();
							product_infos();
							get_picture();
							highlight(barcode);
						} else {
							bobang_fail();
						}
					});
				}
			});
			//全屏回车事件
			$(".body").keypress(function(e){
				var key = e.which;
				if (key == 13) {
					$("#barcode").focus();
				}
			});
			//获取图片
			var get_picture = function(){
				for (var i = 0; i < order.products.length; i++) {
					var product = order.products[i];
					if (!product.delay) {
						product.delay = 1;
						var oimg = new Image();
						oimg.onload = function() {
							var img = $("."+product.barcode);
							img.attr("src",img.data("src"));
							img.attr("style","");
						};
						oimg.src = $("."+product.barcode).data("src");
					}
				}
			};
			//播放成功
			var bobang_success = function(){
				$('.success')[0].pause();
				$('.success')[0].currentTime = 0;
				$('.success')[0].play();
			}
			//播放失败
			var bobang_fail = function(){
				$('.fail')[0].pause();
				$('.fail')[0].currentTime = 0;
				$('.fail')[0].play();
			}
			//计算总价
			var get_total_price = function(){
				order.shopping_infos.total_price = parseFloat(0.00);
				order.shopping_infos.marketing_price = parseFloat(0.00);
				if (order.products.length == 0) {
					order.shopping_infos.total_price = "0.00";
					return;
				}
				for (var i = 0; i < order.products.length; i++) {
					if (order.member) {
						for (var j = 0; j < order.member.discounts.length; j++) {
							if (order.member.discounts[j].org_brand_id == order.products[i].product_brand) {
								order.products[i].product_discount = order.member.discounts[j].discount;
								order.products[i].discount_product_price = parseFloat((order.products[i].product_price*order.products[i].product_discount).toFixed(2));
							}
						}
					}
					order.shopping_infos.marketing_price = order.shopping_infos.marketing_price + order.products[i].product_price*order.products[i].product_number;
					order.shopping_infos.total_price = parseFloat((order.shopping_infos.total_price + order.products[i].discount_product_price*order.products[i].product_number).toFixed(2));
					console.log("marketing_price:"+order.shopping_infos.marketing_price);
				}
			};
			//修改单条商品
			var show_one_line = function(index){
				var product_name = order.products[index].product_name;
				var product_price = order.products[index].product_price;
				var product_number = order.products[index].product_number;

				$(".content").removeAttr("style");

				$("#update_id").val(index);
				$("#update_name").html(product_name);
				$("#update_price").val(product_price);
				$("#update_number").val(product_number);

			};
			//保存单条商品信息
			var save_one_line = function(){
				var index = $("#update_id").val();
				var update_price = $("#update_price").val();
				var update_number =  $("#update_number").val();

				order.products[index].product_price = update_price;
				order.products[index].product_number = parseInt(update_number);

				get_total_price();
				product_infos();
				$(".content").attr("style","display:none;");
			}
			var delete_one_line = function(){
				var index = $("#update_id").val();
				order.products.splice(index,1);
				get_total_price();
				product_infos();
				$(".content").attr("style","display:none;");
			};
			//商品模板信息
			var product_infos = function(){
				var t = _.template($("#products").html());
				$("#product_infos").html(t({shopping_infos:order.shopping_infos,products:order.products}));
				$("#amount").html("￥"+order.shopping_infos.total_price);
				$(".product_line").click(function(){
					$(".product_line").removeClass("curr");
					$(this).addClass("curr");
					var index = $(this).data("id")-1;
					show_one_line(index);
				});
			};
			//关闭单条信息
			$(".close").click(function(){
				$(".content").attr("style","display:none;");
			});
			//保存单条信息
			$(".save").click(function(){
				save_one_line();
			});
			//删除商品
			$(".delete").click(function(){
				delete_one_line();
			});
			//结算
			$("#pay").click(function(){
				order.store_id = store_id;
				if (order.products.length>0) {
					pay_way_change(pay_way_status);
					$("#pay_info").removeAttr("style");
					$(".cash_value").focus();
					payment_info_table();
				}else {
					alert("还没有购买商品！")
				}
			});
			//更新订单状态
			$(".leave").click(function(){
				order.store = store;
				if (order.shopping_infos.ready_pay+order.shopping_infos.small_change >= order.shopping_infos.total_price) {
					$.post("/update_order_status",{"order":JSON.stringify(order)},function(data){
						if (data.success) {
							$(".print").removeAttr("style");
							$(".leave").attr("disabled","disabled");
							$(".refund").show();
							// init_pay_infos();
							// $("#pay_info").attr("style","display:none;");
						}else {
							alert(data.message);
						}
					});
				}else {
					alert("尚未付清全款");
				}
			});
			//打印发票
			$(".print").click(function(){
				if (!order.order_id) {
					alert("order_id is null!");
					return;
				}
				$.get("/search_order_infos",{"order_id":order.order_id},function(data){
					if (data.success) {
						var print_infos ={
							"order" : null,
							"order_details" : null,
							"pay_infos" : null
						};
						print_infos.order = data.order;
						print_infos.order_details = data.order_details;
						print_infos.pay_infos = data.pay_infos;

						$("#pay_info").attr("style","display:none;");
						// $("#receipt_infos").removeAttr("style");
						var t = _.template($("#print_receipt_infos").html());
						$("#print_receipt_info").html(t({print_infos:print_infos}));
						// $(".print_content").printArea();
						print_method(t({print_infos:print_infos}));
                        // $("#receipt_infos").attr("style","display:none;");
                        init_product_infos();
    					init_pay_infos();
    					product_infos();
    					member_update();
						$(".print").attr("style","display:none;");
					}else {

					}
				});

			});
			//打印
			var print_method = function(docStr){
				var newWindow=window.open("打印窗口","_blank");//打印窗口要换成页面的url
				newWindow.document.write(docStr);
				newWindow.document.close();
				newWindow.print();
				newWindow.close();
			};
			//返回
			$(".back").click(function(){
				$("#pay_info").attr("style","display:none;");
			});
			//作废 看商品数量多少，超过10个弹出判断
			$("#clear").click(function(){
				if (order.products.length>10) {
					$(".do_clear").removeAttr("style");
				}else {
					init_product_infos();
					init_pay_infos();
					product_infos();
					member_update();
				}
			});
			//作废是
			$(".yes").click(function(){
				init_product_infos();
				product_infos();
				member_update();
				$(".do_clear").attr("style","display:none;");
			});
			//作废否
			$(".no").click(function(){
				$(".do_clear").attr("style","display:none;");
			});
			//付款信息表显示
			var payment_info_table = function(){
				var t = _.template($("#pay_table_infos").html());
				$(".pay_table").html(t({pay_infos:order.pay_infos,shopping_infos:order.shopping_infos}));
			};
			//付款get方法
			var do_get_method = function(url,params,cb){
				$.get(url,params,function(data){
					if (data.success) {
						cb(data);
					}else {
						alert(data.message);
						return;
					}
				});
			};
			//输入现金
			$(".cash_value").keypress(function(e){
				var pay_amount = $(".cash_value").val();
				var key = e.which;
				if (!pay_amount || key != 13) {
					return;
				}
				pay_amount = parseFloat(pay_amount);
				var changes = parseFloat(0);
				changes = pay_amount-order.shopping_infos.total_price;
				$(".print_invoice").removeAttr("style");
				$(".choose_pay").removeAttr("style");
				//如果金额大于等于订单总计一次性保存订单，并且支付
				if (changes>100) {
					alert("支付额过大");
					return;
				}
				$(".cash_pay").attr("style","display:none;");
				if (!order.order_id) {
					do_get_method("/save_order_detail",{"order":JSON.stringify(order)},function(data){
						order.order_id = data.row.order_id;
						var params = {
							"order":JSON.stringify(order),
							"store_address":store_address,
							"person_id":person_id,
							"pay_amount":pay_amount
						};
						do_get_method("/deal_cash_pay",params,function(data){
							order.shopping_infos.cash_pay = order.shopping_infos.cash_pay+pay_amount;
							add_pay_info("现金",pay_amount,data);
						});
					});
				}else {
					var params = {
						"order":JSON.stringify(order),
						"store_address":store_address,
						"person_id":person_id,
						"pay_amount":pay_amount
					};
					do_get_method("/deal_cash_pay",params,function(data){
						order.shopping_infos.cash_pay = order.shopping_infos.cash_pay+pay_amount;
						add_pay_info("现金",pay_amount,data);
					});
				}
			});
			//输入会员支付号码
			$(".member_pay_card").keypress(function(e){
				var pay_amount = $(".member_value").val();
				var member_pay_card = $(".member_pay_card").val();
				var key = e.which;
				if ( !member_pay_card || key != 13 || !pay_amount) {
					return;
				}
				pay_amount = parseFloat(pay_amount);
				if (pay_amount+order.shopping_infos.ready_pay-order.shopping_infos.total_price > order.shopping_infos.cash_pay ) {
					alert("不能套现");
					return;
				}
				order.pay_way.push("3");
				var changes = parseFloat(0);
				changes = pay_amount-order.shopping_infos.total_price;
				//一次支付
				if (changes >0) {
					alert("超过支付金额！");
					return;
				}
				$(".member_pay_card").val("");
				$(".member_pay").attr("style","display:none;");
				$(".choose_pay").removeAttr("style");
				if (changes <= 0) {
					//一次支付，并生成订单
					if (!order.order_id) {
						do_get_method("/save_order_detail",{"order":JSON.stringify(order),"person_id":person_id},function(data){
							order.order_id = data.row.order_id;
							var params = {
								"order":JSON.stringify(order),
								"paycode":member_pay_card,
								"store_address":store_address,
								"person_id":person_id,
								"pay_amount":pay_amount
							};
							do_get_method("/deal_card_pay",params,function(data){
								add_pay_info("会员卡",pay_amount,data);
							});
						});
					}else {
						var params = {
							"order":JSON.stringify(order),
							"paycode":member_pay_card,
							"store_address":store_address,
							"person_id":person_id,
							"pay_amount":pay_amount
						};
						do_get_method("/deal_card_pay",params,function(data){
							add_pay_info("会员卡",pay_amount,data);
						});
					}
				}
			});
			//白条输入
			$(".credit_value").keypress(function(e){
				var pay_amount = $(".credit_value").val();
				pay_amount = parseFloat(pay_amount);
				var key = e.which;
				if ( !pay_amount || key != 13) {
					return;
				}
				order.pay_way.push("4");
				var changes = parseFloat(0);
				changes = pay_amount-order.shopping_infos.total_price;
				if (pay_amount+order.shopping_infos.ready_pay-order.shopping_infos.total_price > order.shopping_infos.cash_pay ) {
					return;
				}
				//一次支付
				if (changes >0) {
					alert("超过支付金额！");
					return;
				}
				$(".credit_pay").attr("style","display:none;");
				if (!order.order_id) {
					do_get_method("/save_order_detail",{"order":JSON.stringify(order),"person_id":person_id},function(data){
						order.order_id = data.row.order_id;
						var params = {
							"order":JSON.stringify(order),
							"store_address":store_address,
							"person_id":person_id,
							"pay_amount":pay_amount
						};
						do_get_method("/deal_credit_pay",params,function(data){
							add_pay_info("白条",pay_amount,data);
						});
					});
				}else {
					var params = {
						"order":JSON.stringify(order),
						"store_address":store_address,
						"person_id":person_id,
						"pay_amount":pay_amount
					};
					do_get_method("/deal_credit_pay",params,function(data){
						add_pay_info("白条",pay_amount,data);
					});
				}
			});
			//微信转账支付
			$(".weixin_transfer_value").keypress(function(e){
				var pay_amount = $(".weixin_transfer_value").val();
				pay_amount = parseFloat(pay_amount);
				var key = e.which;
				if ( !pay_amount || key != 13) {
					return;
				}
				order.pay_way.push("4");
				var changes = parseFloat(0);
				changes = pay_amount-order.shopping_infos.total_price;
				if (pay_amount+order.shopping_infos.ready_pay-order.shopping_infos.total_price > order.shopping_infos.cash_pay ) {
					return;
				}
				//一次支付
				if (changes >0) {
					alert("超过支付金额！");
					return;
				}
				$(".weixin_transfer_pay").attr("style","display:none;");
				if (!order.order_id) {
					do_get_method("/save_order_detail",{"order":JSON.stringify(order),"person_id":person_id},function(data){
						order.order_id = data.row.order_id;
						var params = {
							"order":JSON.stringify(order),
							"store_address":store_address,
							"person_id":person_id,
							"pay_amount":pay_amount
						};
						do_get_method("/order_wxtransferpay",params,function(data){
							add_pay_info("微信转账",pay_amount,data);
						});
					});
				}else {
					var params = {
						"order":JSON.stringify(order),
						"store_address":store_address,
						"person_id":person_id,
						"pay_amount":pay_amount
					};
					do_get_method("/order_wxtransferpay",params,function(data){
						add_pay_info("微信转账",pay_amount,data);
					});
				}
			});
			//支付宝转账
			$(".ali_transfer_value").keypress(function(e){
				var pay_amount = $(".ali_transfer_value").val();
				pay_amount = parseFloat(pay_amount);
				var key = e.which;
				if ( !pay_amount || key != 13) {
					return;
				}
				order.pay_way.push("4");
				var changes = parseFloat(0);
				changes = pay_amount-order.shopping_infos.total_price;
				if (pay_amount+order.shopping_infos.ready_pay-order.shopping_infos.total_price > order.shopping_infos.cash_pay ) {
					return;
				}
				//一次支付
				if (changes >0) {
					alert("超过支付金额！");
					return;
				}
				$(".ali_transfer_pay").attr("style","display:none;");
				if (!order.order_id) {
					do_get_method("/save_order_detail",{"order":JSON.stringify(order),"person_id":person_id},function(data){
						order.order_id = data.row.order_id;
						var params = {
							"order":JSON.stringify(order),
							"store_address":store_address,
							"person_id":person_id,
							"pay_amount":pay_amount
						};
						do_get_method("/order_alitransferpay",params,function(data){
							add_pay_info("支付宝转账",pay_amount,data);
						});
					});
				}else {
					var params = {
						"order":JSON.stringify(order),
						"store_address":store_address,
						"person_id":person_id,
						"pay_amount":pay_amount
					};
					do_get_method("/order_alitransferpay",params,function(data){
						add_pay_info("支付宝转账",pay_amount,data);
					});
				}
			});
			//支付宝支付
			$(".alipay_code").keypress(function(e){
				var alipay_code = $(".alipay_code").val();
				var pay_amount = $(".alipay_value").val();
				pay_amount = parseFloat(pay_amount);
				var key = e.which;
				if ( !pay_amount || key != 13 || !alipay_code) {
					return;
				}
				$(".alipay_code").val("");
				var changes = parseFloat(0);
				changes = pay_amount-order.shopping_infos.total_price;
				if (pay_amount+order.shopping_infos.ready_pay-order.shopping_infos.total_price > order.shopping_infos.cash_pay ) {
					return;
				}
				//一次支付
				if (changes >0) {
					alert("超过支付金额！");
					return;
				}
				$(".alipay_value").attr("disabled","disabled");
				if (!order.order_id) {
					do_get_method("/save_order_detail",{"order":JSON.stringify(order),"person_id":person_id},function(data){
						order.order_id = data.row.order_id;
						var params = {
							"order":JSON.stringify(order),
							"store_address":store_address,
							"person_id":person_id,
							"alipay_code":alipay_code,
							"pay_amount":pay_amount
						};
						do_get_method("/ali_pay",params,function(data){
							ali_id = data.order_id;
							cnt = 0;
							setTimeout(check_alipay,1000);
						});
					});
				}else {
					var params = {
						"order":JSON.stringify(order),
						"store_address":store_address,
						"person_id":person_id,
						"alipay_code":alipay_code,
						"pay_amount":pay_amount
					};
					if (ali_id) {
						alert("支付过了");
					}else {
						do_get_method("/ali_pay",params,function(data){
							ali_id = data.order_id;
							cnt = 0;
							setTimeout(check_alipay,1000);
						});
					}
				}
			});
			var check_alipay = function(){
				cnt = cnt + 1;
				$.post("/alipay_trade_query",{"order_id":ali_id},function(data){
					if (data.success) {
						add_pay_info("支付宝线下条码支付",parseFloat(data.row.total_amount),data);
					}else if (cnt < 5){
						setTimeout(check_alipay,1000);
					}else {
						alert("已超时，付款未成功！");
					}
				});
			};
			//点击支付方式
			var click_pay_way = function(number){
				pay_way_status = number;
				pay_way_change(pay_way_status);
			};
			//点击现金
			$(".cash").click(function(){
				if (pay_way_status == 10) {
					return;
				}
				click_pay_way(0);
			});
			//支付宝点击
			$(".alipay").click(function(){
				if (pay_way_status == 10) {
					return;
				}
				click_pay_way(1);
			});
			//支付宝转账
			$(".ali_transfer").click(function(){
				if (pay_way_status == 10) {
					return;
				}
				click_pay_way(4);
			});
			//微信转账
			$(".weixin_transfer").click(function(){
				if (pay_way_status == 10) {
					return;
				}
				click_pay_way(5);
			});
			//挂账点击
			$(".credit").click(function(){
				if (pay_way_status == 10) {
					return;
				}
				if (!order.member) {
					alert("请登记会员");
					return;
				}
				click_pay_way(3);
			});
			//会员支付点击
			$(".member_card").click(function(){
				if (pay_way_status == 10) {
					return;
				}
				if (!order.member) {
					alert("请登记会员");
					return;
				}
				click_pay_way(2);
				$(".member_number").val(order.member.mobile);
			});
			//输入会员卡点击
			$(".member").click(function(){
				$(".member_info").removeAttr("style");
				$(".member_phone").focus();
			});
			//输入会员取消
			$("#member_cancel").click(function(){
				$(".member_phone").val("");
				$(".member_info").attr("style","display:none;");
			});
			//会员刷新
			var member_update = function(){
				if (order.member) {
					$(".member_name").html("姓名："+order.member.vip_name);
					$(".member_level").val(order.member.vip_type_name);
					if (!order.member.vip_type_name) {
						$(".member_amount").html("等级：普卡");
					}else {
						$(".member_amount").html("等级："+order.member.vip_type_name);
					}
					if (!order.member.integral) {
						$(".member_integral").html("积分："+"0");
					}else {
						$(".member_integral").html("积分："+order.member.integral);
					}
				}else {
					$(".member_name").html("");
					$(".member_amount").html("");
					$(".member_integral").html("");
				}
				comefocus();
			};
			//会员号码点击
			var member_click = function(member_phone){
				$(".member_phone").val("");
				$.get("/get_member_info",{"q":member_phone},function(data){
					if (data.success) {
						bobang_success();
						order.member = data.row;
						member_update();
						$(".member_info").attr("style","display:none;");
						get_total_price();
						product_infos();
					}else {
						bobang_fail();
					}
				});
			};
			$(".member_phone").keypress(function(e){
				var member_phone = $(".member_phone").val();
				var key = e.which;
				if (member_phone && key == 13) {
					member_click(member_phone);
				}
			});
			$("#member_enter").click(function(){
				var member_phone = $(".member_phone").val();
				if (member_phone) {
					member_click(member_phone);
				}
			});


		});

		function keyUp(e) {
　　       　 var e=e||event;
　　      　   currKey=e.keyCode||e.which||e.charCode;
			if(currKey == 27){
				e.preventDefault();
				$(".member_phone").val("");
				$(".member_info").attr("style","display:none;");
			}else if (currKey == 113) {
				$(".member_phone").val("");
				$(".member_info").attr("style","display:block;");
				$(".member_phone").focus();
			}else if (currKey == 13) {
				var member_phone = $(".member_phone").val();
				if (member_phone) {
					member_click(member_phone);
				}
			}

　　       }
　　       document.onkeyup = keyUp;
	</script>
  </body>
</html>
